<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sentient Jigsaw 10x10 â€” Magnet + Groups</title>
  <style>
    :root{--cream:#F4EFE9;--paper:#FAF7F2;--ink:#141414;--muted:#6f6f6f;--accent:#E6533C;--accent-dark:#C4412D;--line:rgba(0,0,0,0.10);--radius:14px;--shadow:0 10px 30px rgba(0,0,0,0.08)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--cream);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:18px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .app{width:100%;max-width:1200px;display:grid;grid-template-columns:1fr;gap:16px;position:relative}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;position:relative}
    .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:var(--paper)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand img.logo{height:24px;width:auto;display:block}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;font-size:12px;color:#777}
    .panel{padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .stat{background:var(--paper);border:1px solid var(--line);padding:10px 12px;border-radius:12px;min-width:110px;text-align:center}
    .stat small{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
    .stat b{font-size:18px}
    .btn,.btn:link,.btn:visited{appearance:none;-webkit-appearance:none;border:1px solid var(--line);background:var(--paper);color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:650;cursor:pointer;text-decoration:none;display:inline-block;font-family:inherit;letter-spacing:.2px}
    .btn:hover{background:#fff;border-color:rgba(0,0,0,0.18)}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent-dark)}
    .btn.primary:hover{background:var(--accent-dark)}
    .btn.danger{background:#fff0ee;border-color:rgba(230,83,60,0.35);color:#9b2a1a}
    .btn.toggle.active{outline:2px solid rgba(230,83,60,0.35)}
    .wrap{padding:14px 16px}
    .board{position:relative;border-radius:12px;background:var(--paper)}
    #canvas{display:block;width:100%;height:auto;border-radius:12px}
    .footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.96);z-index:10;overflow:hidden}
    .overlay .menu{position:relative;z-index:2;background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:28px;min-width:320px;text-align:center}
    .overlay .menu h1{margin:0 0 14px 0;font-size:22px}
    .menu .v{display:flex;flex-direction:column;gap:10px}
    #menuBG{position:absolute;inset:0;z-index:1;pointer-events:none;opacity:.9}
    #lbList{max-height:55vh;overflow:auto;text-align:left}
    .lbrow{display:grid;grid-template-columns:32px 1fr 90px 70px;gap:10px;padding:8px 0;border-bottom:1px solid rgba(0,0,0,.06)}
    .lbrow b{font-weight:650}
    .inline{display:flex;gap:8px;justify-content:center;align-items:center}
    input[type="text"]{border:1px solid var(--line);border-radius:10px;padding:9px 12px;font:inherit}
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="card">
      <div class="header">
        <div class="brand">
          <img src="logo.png" alt="Sentient" class="logo" onerror="this.style.display='none'">
          <div>sentient</div>
        </div>
        <div class="pill">10x10 jigsaw</div>
      </div>
      <div class="panel">
        <div class="left" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="stat"><small>Time</small><b id="time">00:00.0</b></div>
          <div class="stat"><small>Moves</small><b id="moves">0</b></div>
          <div class="stat"><small>Status</small><b id="status">Menu</b></div>
        </div>
        <div class="right" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="menuBtn">Main Menu</button>
          <button class="btn primary" id="shuffleBtn">Shuffle</button>
          <button class="btn" id="ghostBtn">Ghost image</button>
          <button class="btn toggle" id="snapBtn">Magnet</button>
          <button class="btn danger" id="resetBtn">Reset</button>
        </div>
      </div>
      <div class="wrap">
        <div class="board"><canvas id="canvas" width="1100" height="700" aria-label="Puzzle board"></canvas></div>
      </div>
      <div class="footer"><div>&nbsp;</div><div>&nbsp;</div></div>

      <!-- Main menu -->
      <div class="overlay" id="menuOverlay" style="display:flex">
        <canvas id="menuBG"></canvas>
        <div class="menu">
          <h1>Sentient Jigsaw</h1>
          <div class="v">
            <button class="btn primary" id="startBtn" disabled>Start</button>
            <button class="btn" id="leaderBtn">Leaderboard</button>
            <a class="btn" href="https://sentient.foundation/" target="_blank" rel="noopener noreferrer">Join Sentient</a>
          </div>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="overlay" id="leaderOverlay">
        <div class="menu" style="min-width:460px">
          <h1>Leaderboard (Top 25)</h1>
          <div class="inline" style="margin-bottom:10px">
            <input type="text" id="nameInput" placeholder="Your name (optional)" maxlength="20">
            <button class="btn" id="saveNameBtn">Save</button>
          </div>
          <div id="lbList"></div>
          <div class="v" style="margin-top:10px">
            <button class="btn" id="refreshLbBtn">Refresh</button>
            <button class="btn" id="closeLeaderBtn">Back</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Firebase + Game -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Your Firebase config (baked-in)
const firebaseConfig = {
  apiKey: "AIzaSyBU4bgTnFpNdDOUJ5Ub-IiXH-1LeLJcUkQ",
  authDomain: "puzzle-dobby.firebaseapp.com",
  projectId: "puzzle-dobby",
  storageBucket: "puzzle-dobby.firebasestorage.app",
  messagingSenderId: "817091874347",
  appId: "1:817091874347:web:0f2ee94e14951ce08c646e",
  measurementId: "G-SGZ5Q8Z95G"
};

let FB_ENABLED = false;
let fb = { app:null, db:null };
try {
  fb.app = initializeApp(firebaseConfig);
  fb.db = getFirestore(fb.app);
  FB_ENABLED = true;
} catch(e) {
  console.warn("Firebase not available:", e);
}

// name helpers
const nameKey = "sj_name";
const getName = () => localStorage.getItem(nameKey) || "";
const setName = (n) => localStorage.setItem(nameKey, n || "");

// Save score (client-only basic version)
async function saveScoreBasic({timeMs, moves, rows, cols}){
  if(!FB_ENABLED) return;
  try{
    await addDoc(collection(fb.db, "scores"), {
      name: getName() || null,
      timeMs, moves, rows, cols,
      createdAt: serverTimestamp()
    });
  }catch(e){ console.warn("saveScore error", e); }
}

async function loadLeaderboardBasic(){
  const lbList = document.getElementById('lbList');
  lbList.innerHTML = '<div style="color:#6f6f6f">Loading...</div>';
  if(!FB_ENABLED){ lbList.innerHTML = '<div style="color:#9b2a1a">Firebase not configured.</div>'; return; }
  try{
    const q = query(collection(fb.db, "scores"), orderBy("timeMs","asc"), limit(25));
    const snap = await getDocs(q);
    const rows = snap.docs.map(d=>d.data());
    if (!rows.length){ lbList.innerHTML = '<div style="color:#6f6f6f">No scores yet.</div>'; return; }
    lbList.innerHTML = '';
    rows.forEach((s,i)=>{
      const div = document.createElement('div'); div.className = 'lbrow';
      const name = s.name || 'anon';
      div.innerHTML = `<div><b>#${i+1}</b></div><div>${name}</div><div>${fmt(s.timeMs||0)}</div><div>${s.moves||0} mv</div>`;
      lbList.appendChild(div);
    });
  }catch(e){
    lbList.innerHTML = '<div style="color:#9b2a1a">Failed to load leaderboard.</div>';
  }
}

// ---------------- GAME -----------------
const ROWS = 10, COLS = 10;
const IMAGE_URL = 'pazzle.png';
const DOBBY_URL = 'dobby.png';
const CANVAS = document.getElementById('canvas');
const CTX = CANVAS.getContext('2d');

const timeEl = document.getElementById('time');
const movesEl = document.getElementById('moves');
const statusEl = document.getElementById('status');
const shuffleBtn = document.getElementById('shuffleBtn');
const resetBtn = document.getElementById('resetBtn');
const ghostBtn = document.getElementById('ghostBtn');
const snapBtn = document.getElementById('snapBtn');
const menuBtn = document.getElementById('menuBtn');

const menuOverlay = document.getElementById('menuOverlay');
const startBtn = document.getElementById('startBtn');
const leaderBtn = document.getElementById('leaderBtn');
const leaderOverlay = document.getElementById('leaderOverlay');
const refreshLbBtn = document.getElementById('refreshLbBtn');
const closeLeaderBtn = document.getElementById('closeLeaderBtn');
const nameInput = document.getElementById('nameInput');
const saveNameBtn = document.getElementById('saveNameBtn');

const menuBG = document.getElementById('menuBG');
const mbgCtx = menuBG.getContext('2d');

let started=false, finished=false, moves=0;
let timer=null, startTime=0, elapsed=0;
let useMagnet=true, inMenu=true, hasImage=false, ghostOn=false;

snapBtn.classList.add('active');

function fmt(ms){
  const t = Math.floor(ms);
  const s = Math.floor(t/1000);
  const m = Math.floor(s/60);
  const sec = s % 60;
  const tenths = Math.floor((t % 1000)/100);
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${tenths}`;
}
function startTimerOnce(){
  if (!started && !finished && !inMenu){
    started = true; startTime = performance.now();
    timer = setInterval(()=>{ elapsed = performance.now() - startTime; timeEl.textContent = fmt(elapsed); }, 60);
    statusEl.textContent = 'Playing';
  }
}
function stopTimer(){ if (timer){ clearInterval(timer); timer=null; } }
function resetTimer(){ stopTimer(); started=false; elapsed=0; timeEl.textContent='00:00.0'; }

// Images
const img = new Image(); img.src = IMAGE_URL;
img.onload = ()=>{ hasImage = true; startBtn.disabled = false; };
img.onerror = ()=>{ hasImage = false; startBtn.disabled = true; };

const dobby = new Image(); let dobbyLoaded = false; dobby.src = DOBBY_URL;
dobby.onload = ()=>{ dobbyLoaded = true; if(inMenu) initMenuBG(); };
dobby.onerror = ()=>{ dobbyLoaded = false; };

// Geometry
let board = {x:80,y:60,w:CANVAS.width-160,h:CANVAS.height-120};
let tileW=0, tileH=0;
function resizeBoardToImage(){
  const cw = CANVAS.width - 160, ch = CANVAS.height - 120;
  const naturalW = img.naturalWidth || 1100;
  const naturalH = img.naturalHeight || 700;
  const aspect = naturalW / naturalH;
  let w = cw, h = Math.round(cw / aspect);
  if (h > ch){ h = ch; w = Math.round(h * aspect); }
  board.w = w; board.h = h;
  board.x = Math.round((CANVAS.width - w)/2);
  board.y = Math.round((CANVAS.height - h)/2);
  tileW = board.w / COLS; tileH = board.h / ROWS;
}

// Groups
let gid=1;
function makeGroup(p){ const g={id:gid++,pieces:[]}; g.pieces.push(p); p.group=g; return g; }
function moveGroup(g,dx,dy){ for (const k of g.pieces){ k.x+=dx; k.y+=dy; } }
function mergeGroups(a,b){ if(a===b) return; for(const k of b.pieces){ k.group=a; a.pieces.push(k);} b.pieces.length=0; }
function allInOneGroup(){ const g0=pieces[0].group; for(let i=1;i<pieces.length;i++){ if(pieces[i].group!==g0) return false;} return true; }

let pieces=[];
const rand=(a,b)=> a+Math.random()*(b-a);
function genEdges(){
  const edges=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>({top:0,right:0,bottom:0,left:0})));
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const e=edges[r][c];
      if(r===0)e.top=0; else e.top=-edges[r-1][c].bottom;
      if(c===0)e.left=0; else e.left=-edges[r][c-1].right;
      if(c===COLS-1)e.right=0; else e.right=Math.random()<0.5?1:-1;
      if(r===ROWS-1)e.bottom=0; else e.bottom=Math.random()<0.5?1:-1;
    }
  }
  return edges;
}
function piecePath(ctx,w,h,tab,e){
  const tabD=tab; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(w*0.33,0);
  if(e.top!==0){ const dir=e.top, cy=-tabD*dir; ctx.bezierCurveTo(w*0.38,0,w*0.38,cy,w*0.5,cy); ctx.bezierCurveTo(w*0.62,cy,w*0.62,0,w*0.67,0); }
  ctx.lineTo(w,0); ctx.lineTo(w,h*0.33);
  if(e.right!==0){ const dir=e.right, cx=w+tabD*dir; ctx.bezierCurveTo(w,h*0.38,cx,h*0.38,cx,h*0.5); ctx.bezierCurveTo(cx,h*0.62,w,h*0.62,w,h*0.67); }
  ctx.lineTo(w,h); ctx.lineTo(w*0.67,h);
  if(e.bottom!==0){ const dir=e.bottom, cy=h+tabD*dir; ctx.bezierCurveTo(w*0.62,h,w*0.62,cy,w*0.5,cy); ctx.bezierCurveTo(w*0.38,cy,w*0.38,h,w*0.33,h); }
  ctx.lineTo(0,h); ctx.lineTo(0,h*0.67);
  if(e.left!==0){ const dir=e.left, cx=-tabD*dir; ctx.bezierCurveTo(0,h*0.62,cx,h*0.62,cx,h*0.5); ctx.bezierCurveTo(cx,h*0.38,0,h*0.38,0,h*0.33); }
  ctx.closePath();
}
function spawnOutsideCenter(bw,bh){
  const M=12,GAP=10; let tries=0;
  while(tries<5000){
    const x=Math.round(rand(M,CANVAS.width-bw-M));
    const y=Math.round(rand(M,CANVAS.height-bh-M));
    const inX = x < (board.x+board.w+GAP) && (x+bw) > (board.x-GAP);
    const inY = y < (board.y+board.h+GAP) && (y+bh) > (board.y-GAP);
    if(!(inX&&inY)) return {x,y}; tries++;
  }
  return {x:M,y:M};
}
function buildPieces(){
  pieces.length=0; resizeBoardToImage();
  const tab=Math.min(tileW,tileH)*0.22; const edges=genEdges();
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const bw=Math.ceil(tileW+tab*2), bh=Math.ceil(tileH+tab*2);
      const off=document.createElement('canvas'); off.width=bw; off.height=bh; const octx=off.getContext('2d');
      octx.save(); octx.translate(tab,tab); piecePath(octx,tileW,tileH,tab,edges[r][c]); octx.shadowColor='rgba(0,0,0,0.12)'; octx.shadowBlur=8; octx.shadowOffsetY=2; octx.clip();
      const destX=-c*tileW-tab, destY=-r*tileH-tab; octx.drawImage(img,0,0,img.naturalWidth||1100,img.naturalHeight||700,destX,destY,board.w+tab*2,board.h+tab*2);
      octx.restore(); octx.translate(tab,tab); octx.lineWidth=1; octx.strokeStyle='rgba(0,0,0,0.35)'; piecePath(octx,tileW,tileH,tab,edges[r][c]); octx.stroke();
      const tx=Math.round(board.x + c*tileW - tab), ty=Math.round(board.y + r*tileH - tab); const spawn=spawnOutsideCenter(bw,bh);
      const p={r,c,tx,ty,x:spawn.x,y:spawn.y,bw,bh,bmp:off,group:null}; makeGroup(p); pieces.push(p);
    }
  }
}
function draw(ghost=false){
  CTX.clearRect(0,0,CANVAS.width,CANVAS.height);
  if(ghost&&hasImage){ CTX.globalAlpha=.18; CTX.drawImage(img,0,0,img.naturalWidth||1100,img.naturalHeight||700,board.x,board.y,board.w,board.h); CTX.globalAlpha=1; }
  for(let i=0;i<pieces.length;i++){ const p=pieces[i]; if(p===draggingPiece) continue; CTX.drawImage(p.bmp,p.x,p.y); }
  if(draggingPiece){ CTX.drawImage(draggingPiece.bmp,draggingPiece.x,draggingPiece.y); }
}
function hitPiece(p,x,y){ return x>=p.x && y>=p.y && x<=p.x+p.bw && y<=p.y+p.bh; }
function pieceAt(r,c){ if(r<0||c<0||r>=ROWS||c>=COLS)return null; for(const p of pieces){ if(p.r===r && p.c===c) return p; } return null; }
function tryMagnetizeFrom(p){
  if(!useMagnet) return false; const gA=p.group; const th=Math.min(tileW,tileH)*0.28; const ns=[[p.r,p.c-1],[p.r,p.c+1],[p.r-1,p.c],[p.r+1,p.c]];
  for(const [nr,nc] of ns){
    const q=pieceAt(nr,nc); if(!q||q.group===gA) continue;
    const idealDx=q.tx-p.tx, idealDy=q.ty-p.ty; const realDx=q.x-p.x, realDy=q.y-p.y;
    const offX=idealDx-realDx, offY=idealDy-realDy; const d=Math.hypot(offX,offY);
    if(d<th){ moveGroup(q.group,offX,offY); mergeGroups(gA,q.group); return true; }
  }
  return false;
}
let draggingPiece=null, draggingGroup=null, lastPX=0, lastPY=0;
function reorderGroupToTop(g){ const o=[], gm=[]; for(const p of pieces){ (p.group===g?gm:o).push(p); } pieces=o.concat(gm); }
function groupBounds(g){ let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0; for(const p of g.pieces){ if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y; if(p.x+p.bw>maxX)maxX=p.x+p.bw; if(p.y+p.bh>maxY)maxY=p.y+p.bh; } return {minX,minY,maxX,maxY}; }
function clampDeltaToCanvas(g,dx,dy){ const M=6; const b=groupBounds(g); if(b.minX+dx<M) dx=M-b.minX; if(b.minY+dy<M) dy=M-b.minY; if(b.maxX+dx>CANVAS.width-M) dx=(CANVAS.width-M)-b.maxX; if(b.maxY+dy>CANVAS.height-M) dy=(CANVAS.height-M)-b.maxY; return {dx,dy}; }
function pointerDown(x,y){ if(finished||inMenu) return; startTimerOnce(); for(let i=pieces.length-1;i>=0;i--){ const p=pieces[i]; if(hitPiece(p,x,y)){ draggingPiece=p; draggingGroup=p.group; lastPX=x; lastPY=y; reorderGroupToTop(draggingGroup); break; } } }
function pointerMove(x,y){ if(!draggingGroup) return; let dx=x-lastPX, dy=y-lastPY; const c=clampDeltaToCanvas(draggingGroup,dx,dy); dx=c.dx; dy=c.dy; moveGroup(draggingGroup,dx,dy); lastPX+=dx; lastPY+=dy; draw(ghostOn); }
async function pointerUp(x,y){
  if(!draggingGroup) return; draggingPiece=null; moves++; movesEl.textContent=moves;
  let attached=true; while(useMagnet&&attached){ attached=false; const base=[...draggingGroup.pieces]; for(const p of base){ if(tryMagnetizeFrom(p)){ attached=true; break; } } }
  if(allInOneGroup()){ finished=true; stopTimer(); statusEl.textContent='Solved'; CANVAS.animate([{opacity:1},{opacity:.85},{opacity:1}],{duration:420});
    await saveScoreBasic({ timeMs: Math.round(elapsed), moves, rows: ROWS, cols: COLS });
  }
  draggingGroup=null; draw(ghostOn);
}
// Inputs
CANVAS.addEventListener('mousedown', (e)=>{ const r=CANVAS.getBoundingClientRect(); pointerDown(e.clientX-r.left,e.clientY-r.top); });
window.addEventListener('mousemove', (e)=>{ const r=CANVAS.getBoundingClientRect(); pointerMove(e.clientX-r.left,e.clientY-r.top); });
window.addEventListener('mouseup',   (e)=>{ const r=CANVAS.getBoundingClientRect(); pointerUp(e.clientX-r.left,e.clientY-r.top); });
CANVAS.addEventListener('touchstart',(e)=>{ const t=e.changedTouches[0],r=CANVAS.getBoundingClientRect(); pointerDown(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});
CANVAS.addEventListener('touchmove', (e)=>{ const t=e.changedTouches[0],r=CANVAS.getBoundingClientRect(); pointerMove(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});
CANVAS.addEventListener('touchend',  (e)=>{ const t=e.changedTouches[0],r=CANVAS.getBoundingClientRect(); pointerUp(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});

// Buttons
ghostBtn.addEventListener('click', ()=>{ if(!hasImage) return; ghostOn=!ghostOn; draw(ghostOn); });
snapBtn.addEventListener('click', ()=>{ useMagnet=!useMagnet; snapBtn.classList.toggle('active',useMagnet); });
shuffleBtn.addEventListener('click', ()=>{ if(!hasImage){ statusEl.textContent='Image not loaded'; return; } buildPieces(); moves=0; movesEl.textContent=0; resetTimer(); finished=false; statusEl.textContent='Ready'; draw(false); });
resetBtn.addEventListener('click', ()=>{ if(!hasImage){ statusEl.textContent='Image not loaded'; return; } const g={id:gid++,pieces:[]}; for(const p of pieces){ p.x=p.tx; p.y=p.ty; p.group=g; g.pieces.push(p);} moves=0; movesEl.textContent=0; resetTimer(); finished=false; statusEl.textContent='Ready'; draw(false); });

function openMenu(){ inMenu=true; menuOverlay.style.display='flex'; leaderOverlay.style.display='none'; stopTimer(); statusEl.textContent='Menu'; if(dobbyLoaded) initMenuBG(); }
function closeMenuAndStart(){ if(!hasImage) return; inMenu=false; menuOverlay.style.display='none'; leaderOverlay.style.display='none'; shuffleBtn.click(); }

menuBtn.addEventListener('click', openMenu);
startBtn.addEventListener('click', closeMenuAndStart);

leaderBtn.addEventListener('click', async ()=>{ leaderOverlay.style.display='flex'; menuOverlay.style.display='none'; nameInput.value = getName(); await loadLeaderboardBasic(); });
closeLeaderBtn.addEventListener('click', ()=>{ leaderOverlay.style.display='none'; menuOverlay.style.display='flex'; });
refreshLbBtn.addEventListener('click', loadLeaderboardBasic);
saveNameBtn.addEventListener('click', ()=>{ setName(nameInput.value.trim()); });

// Resize
function fitCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cardRect = document.getElementById('card').getBoundingClientRect();
  const cRect = CANVAS.getBoundingClientRect();
  CANVAS.width = Math.round(cRect.width * dpr);
  CANVAS.height = Math.round(cRect.height * dpr);
  CTX.setTransform(dpr,0,0,dpr,0,0);
  if(hasImage && !inMenu && pieces.length){ resizeBoardToImage(); draw(ghostOn); }
  menuBG.width = Math.round(cardRect.width * dpr);
  menuBG.height = Math.round(cardRect.height * dpr);
  menuBG.style.width = cardRect.width + 'px';
  menuBG.style.height = cardRect.height + 'px';
  mbgCtx.setTransform(dpr,0,0,dpr,0,0);
}
const ro = new ResizeObserver(()=> fitCanvas()); ro.observe(document.getElementById('card')); setTimeout(()=>fitCanvas(), 0);
window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='p' && hasImage){ ghostOn=!ghostOn; draw(ghostOn); } });

// Start
openMenu();

// ---- Menu BG (Dobbys) ----
let mobs=[], mouse={x:-9999,y:-9999}, bgAnim=false;
function initMenuBG(){
  if(!dobbyLoaded) return;
  const N=50; mobs.length=0;
  const w=menuBG.width, h=menuBG.height;
  for(let i=0;i<N;i++){ const s=Math.random()*30+18; mobs.push({ x:Math.random()*w, y:Math.random()*h, vx:(Math.random()*2-1)*0.35, vy:(Math.random()*2-1)*0.35, size:s, rot:(Math.random()*Math.PI*2) }); }
  if(!bgAnim){ bgAnim=true; requestAnimationFrame(tickBG); }
}
function tickBG(){
  if(!inMenu){ bgAnim=false; return; }
  mbgCtx.clearRect(0,0,menuBG.width,menuBG.height);
  const w=menuBG.width, h=menuBG.height;
  for(const m of mobs){
    m.vx += (Math.random()*2-1)*0.02; m.vy += (Math.random()*2-1)*0.02;
    const scaleX = menuBG.width / menuBG.clientWidth, scaleY = menuBG.height / menuBG.clientHeight;
    const mx = mouse.x*scaleX, my = mouse.y*scaleY; const dx=m.x-mx, dy=m.y-my;
    const R=140, R2=R*R, d2=dx*dx+dy*dy;
    if(d2<R2){ const f=(R2-d2)/R2, ang=Math.atan2(dy,dx); m.vx+=Math.cos(ang)*f*1.3; m.vy+=Math.sin(ang)*f*1.3; }
    const sp=Math.hypot(m.vx,m.vy), max=1.6; if(sp>max){ m.vx=m.vx/sp*max; m.vy=m.vy/sp*max; }
    m.vx*=0.995; m.vy*=0.995; m.x+=m.vx; m.y+=m.vy;
    if(m.x<-60)m.x=w+60; if(m.x>w+60)m.x=-60; if(m.y<-60)m.y=h+60; if(m.y>h+60)m.y=-60;
    const sz=m.size; mbgCtx.save(); mbgCtx.translate(m.x,m.y); mbgCtx.rotate(m.rot); mbgCtx.globalAlpha=0.78; mbgCtx.drawImage(dobby,-sz/2,-sz/2,sz,sz); mbgCtx.restore();
  }
  requestAnimationFrame(tickBG);
}
menuOverlay.addEventListener('mousemove', (e)=>{ const r=menuOverlay.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top; });
menuOverlay.addEventListener('mouseleave', ()=>{ mouse.x=-9999; mouse.y=-9999; });
</script>
</body>
</html>
